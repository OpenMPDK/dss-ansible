---

- name: Find a host that has a defined combined_interface_switch_vlan_map
  set_fact:
    combined_interface_switch_vlan_map: "{{ hostvars[host]['combined_interface_switch_vlan_map'] }}"
  loop: "{{ groups['clients'] + groups['servers'] }}"
  loop_control:
    loop_var: host
  when:
    - hostvars[host]['combined_interface_switch_vlan_map'] is defined
    - combined_interface_switch_vlan_map is not defined

- name: Assert combined_interface_switch_vlan_map is defined
  assert:
    that: combined_interface_switch_vlan_map is defined
    fail_msg: Unable to obtain a list of MAC addresses from hosts. Check for playbook failures.
    quiet: true

- name: Set switchport mode access
  onyx_config:
    lines:
      - "interface ethernet {{ link.switch_port }} switchport mode access"
    save: true
  loop: "{{ combined_interface_switch_vlan_map }}"
  loop_control:
    loop_var: link
    label: "Eth{{ link.switch_port }}, VLAN ID {{ link.vlan_id }}"
  when: link.switch_name == inventory_hostname
