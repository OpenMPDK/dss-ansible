---

- name: Identify kvssd firmware
  include_role:
    name: identify_kvssd_firmware
  when: target_fw_version is not defined

- name: Query list of NVMe devices
  command: nvme list -o json
  changed_when: false
  register: nvme_list
  become: true

- name: Set kvssd_format_list variable
  set_fact:
    kvssd_format_list: "{{ kvssd_format_list | default([]) + [ kvssd.DevicePath ] }}"
  loop: "{{ (nvme_list.stdout | from_json).Devices }}"
  loop_control:
    label: "{{ kvssd.DevicePath }}"
    loop_var: kvssd
  when:
    - kvssd.ModelNumber in kvssd_models
    - kvssd.Firmware == target_fw_version

- name: Format kvssd devices
  command: "nvme format {{ kvssd_device_path }} -s0 -n1"
  register: kvssd_format
  async: 300
  poll: 0
  vars:
    kvssd_device_path: "{{ format_kvssd | regex_replace('n\\d+$', '') }}"
    kvssd_fw_bin: "{{ upgrade_kvssd_firmware_staging_dir }}/{{ firmware_bin.files[0].path | basename }}"
  loop: "{{ kvssd_format_list }}"
  loop_control:
    label: "{{ kvssd_device_path }}"
    loop_var: format_kvssd
  become: true

- name: Check async nvme reset
  include_tasks: check_async.yml
  vars:
    async_name: "format kvssd"
    async_tasks: "{{ kvssd_format.results }}"
