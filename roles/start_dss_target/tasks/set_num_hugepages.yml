---

- name: Set Hugepages vars for VMs
  set_fact:
    num_2mb_hugepages: 12288
    num_1gb_hugepages: 0
  when: ansible_virtualization_role == "guest"

- name: Set Hugepages vars for physical hosts
  set_fact:
    num_2mb_hugepages: 12288
    num_1gb_hugepages: 120
  when: ansible_virtualization_role == "host"

- name: Check 2MB hugepages
  command: cat /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
  changed_when: false
  register: current_2mb_hugepages

- name: Check 1GB hugepages
  command: cat /sys/kernel/mm/hugepages/hugepages-1048576kB/nr_hugepages
  changed_when: false
  register: current_1gb_hugepages

- name: Zero 2MB hugepages
  shell: echo 0 >  /sys/kernel/mm/hugepages/hugepages-2048kB/nr_hugepages
  when: current_2mb_hugepages.stdout != num_2m_hugepages

- name: Zero 1GB hugepages
  shell: echo 0 >  /sys/kernel/mm/hugepages/hugepages-1048576kB/nr_hugepages
  when: current_1gb_hugepages.stdout != num_1gb_hugepages

- name: Assert host has sufficient memory
  assert:
    that: ((num_2mb_hugepages | int * 2) + (num_1gb_hugepages | int * 1024)) < ansible_memtotal_mb
    fail_msg: |
      {{ (num_2mb_hugepages | int * 2) + (num_1gb_hugepages | int * 1024) }} MB memory needed for hugepages allocation.
      System only has {{ ansible_memtotal_mb }} MB memory.
    success_msg: Adequate memory available.
