---

- name: Stop and disable ufm service
  systemd:
    name: "{{ ufm_service_file | basename }}"
    state: stopped
    daemon_reload: yes
    enabled: no
  register: stop_service
  failed_when:
    - stop_service.msg is defined
    - "'Could not find' not in stop_service.msg"
  become: yes

- name: List stuck Fabric Manager processes
  command: pgrep -f '[f]abricmanager.py'
  changed_when: false
  failed_when: false
  register: fm_proc

- name: Kill stuck Fabric Manager processes
  command: "kill -9 {{ item }}"
  loop: "{{ fm_proc.stdout_lines }}"
  when: fm_proc.stdout_lines
  become: yes
