---

- name: Install softROCE dependencies
  package:
      name: "{{ packages }}"
      state: present
  vars:
      packages:
      - rdma
      - libibverbs-utils
      - librdmacm-utils
  become: true

- name: Create softROCE service file
  blockinfile:
    path: "{{ install_softROCE_dir }}/softROCE.service"
    create: yes
    block: |
      [Unit]
      Description=Load softROCE
      After=network.target

      [Service]
      Type=simple
      ExecStart=/bin/rxe_cfg start

      [Install]
      WantedBy=multi-user.target
  become: true

- name: Start and Enable softROCE
  systemd:
    name: softROCE.service
    state: started
    enabled: yes
  become: true

- name: Query SoftROCE Configuration
  shell: "rxe_cfg status | grep {{ rdma_interface }} | awk '{ print $7 }'"
  changed_when: false
  register: softROCE_status
  become: true

- name: Test if configured
  debug:
    msg: "Interface {{ rdma_interface }} is configured"
  when: softROCE_status.stdout is regex("^rxe[0-9]+")
  become: true

- name: Test if not configured
  debug:
    msg: "Interface {{ rdma_interface }} is not configured"
  when: not softROCE_status.stdout is regex("^rxe[0-9]+")
  become: true

- name: Attach second interface to softROCE
  shell: "rxe_cfg add {{ rdma_interface }}"
  when: not softROCE_status.stdout is regex("^rxe[0-9]+")
  become: true


