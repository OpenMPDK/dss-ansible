---

- name: Find a host that has a defined combined_interface_switch_vlan_map
  set_fact:
    combined_interface_switch_vlan_map: "{{ hostvars[host]['combined_interface_switch_vlan_map'] }}"
  loop: "{{ groups['clients'] + groups['servers'] }}"
  loop_control:
    loop_var: host
  when:
    - hostvars[host]['combined_interface_switch_vlan_map'] is defined
    - combined_interface_switch_vlan_map is not defined

- name: Assert combined_interface_switch_vlan_map is defined
  assert:
    that: combined_interface_switch_vlan_map is defined
    fail_msg: Unable to obtain a list of MAC addresses from hosts. Check for playbook failures.
    quiet: true

- name: Enable PFC
  onyx_config:
    lines:
      - dcb priority-flow-control enable force

- name: Set pfc_prio_list
  set_fact:
    pfc_prio_list: "{% for vlan in (rocev2_vlans + tcp_vlans) | map(attribute='id') | list %}[ {{ (vlan | string)[0] }} ] + {% endfor %}[ 0 ]"

- name: Set PFC priorities
  onyx_config:
    lines:
      - "dcb priority-flow-control priority {{ item }} enable"
  loop: "{{ pfc_prio_list | unique }}"

- name: Configure TCP VLANs
  onyx_vlan:
    vlan_id: "{{ item.id }}"
    name: "TCP_vlan{{ item.id }}"
  loop: "{{ tcp_vlans }}"
  loop_control:
    label: "{{ item.id }}"

- name: Configure RoCEv2 VLANs
  onyx_vlan:
    vlan_id: "{{ item.id }}"
    name: "RoCE_vlan{{ item.id }}"
  loop: "{{ rocev2_vlans }}"
  loop_control:
    label: "{{ item.id }}"

- name: Configure interfaces
  onyx_config:
    lines:
      - "interface ethernet {{ link.switch_port }} switchport mode hybrid"
      - "interface ethernet {{ link.switch_port }} switchport hybrid allowed-vlan add {{ link.vlan_id }}"
      - "interface ethernet {{ link.switch_port }} qos trust L2"
      - "interface ethernet {{ link.switch_port }} traffic-class 3 congestion-control ecn minimum-absolute 150 maximum-absolute 1500"
    save: true
  loop: "{{ combined_interface_switch_vlan_map }}"
  loop_control:
    loop_var: link
    label: "Eth{{ link.switch_port }}, VLAN ID {{ link.vlan_id }}"
  when: link.switch_name == inventory_hostname

- name: Enable PFC
  onyx_pfc_interface:
    name: "Eth{{ link.switch_port }}"
    state: enabled
  loop: "{{ combined_interface_switch_vlan_map }}"
  loop_control:
    loop_var: link
    label: "Eth{{ link.switch_port }}, VLAN ID {{ link.vlan_id }}"
  when: link.switch_name == inventory_hostname

- name: Configure MTU
  onyx_interface:
    name: "Eth{{ link.switch_port }}"
    mtu: "{{ mtu_size }}"
  loop: "{{ combined_interface_switch_vlan_map }}"
  loop_control:
    loop_var: link
    label: "Eth{{ link.switch_port }}, VLAN ID {{ link.vlan_id }}"
  when: link.switch_name == inventory_hostname
