---

- name: Find a host that has a defined vlan_mac_list
  set_fact:
    vlan_mac_list: "{{ hostvars[host]['vlan_mac_list'] }}"
  loop: "{{ groups['clients'] + groups['servers'] }}"
  loop_control:
    loop_var: host
  when:
    - hostvars[host]['vlan_mac_list'] is defined
    - vlan_mac_list is not defined

- name: Assert vlan_mac_list is defined
  assert:
    that: vlan_mac_list is defined
    fail_msg: Unable to obtain a list of MAC addresses from hosts. Check for playbook failures.
    quiet: true

- name: Query lldp remote
  onyx_command:
    commands: show lldp remote
  register: lldp_list

- name: Enable PFC
  onyx_config:
    lines:
      - dcb priority-flow-control enable force

- name: Set pfc_prio_list
  set_fact:
    pfc_prio_list: "{% for vlan in (rocev2_vlans + tcp_vlans) | map(attribute='id') | list %}[ {{ (vlan | string)[0] }} ] + {% endfor %}[ 0 ]"

- name: Set PFC priorities
  onyx_config:
    lines:
      - "dcb priority-flow-control priority {{ item }} enable"
  loop: "{{ pfc_prio_list | unique }}"

- name: Configure VLANs
  include_tasks: configure_vlan.yml
  vars:
    vlan_id: "{{ item.id }}"
    vlan_prefix: "{{ item.prefix }}"
    mac_addresses: "{{ item.mac_list }}"
  loop: "{{ vlan_mac_list }}"
  loop_control:
    label: "{{ vlan_id }}"
