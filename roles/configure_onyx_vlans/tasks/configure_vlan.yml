---

- name: Configure {{ vlan_prefix }}{{ vlan_id }}
  onyx_vlan:
    vlan_id: "{{ vlan_id }}"
    name: "{{ vlan_prefix }}{{vlan_id}}"

- name: Initialize interfaces
  set_fact:
    interfaces: []
    
- name: Set interfaces for {{ vlan_prefix }}{{ vlan_id }}
  set_fact:
    interfaces: "{{ interfaces | default([]) + [ lldp_list.stdout.0 | regex_search(lldp_regex, '\\1') | first ] }}"
  loop: "{{ mac_addresses }}"
  loop_control:
    loop_var: mac_address
  vars:
    lldp_regex: "Eth([^ ]+) +{{ mac_address }}"

- name: Configure interfaces for {{ vlan_prefix }}{{ vlan_id }}
  onyx_config:
    lines:
      - "interface ethernet {{ interface }} switchport mode hybrid"
      - "interface ethernet {{ interface }} switchport hybrid allowed-vlan add {{ vlan_id }}"
      - "interface ethernet {{ interface }} qos trust L2"
      - "interface ethernet {{ interface }} traffic-class 3 congestion-control ecn minimum-absolute 150 maximum-absolute 1500"
    save: yes
  loop: "{{ interfaces }}"
  loop_control:
    loop_var: interface

- name: Enable PFC for {{ vlan_prefix }}{{ vlan_id }}
  onyx_pfc_interface:
    name: "Eth{{ interface }}"
    state: enabled
      - "Eth{{ interface }}"
      - enabled
  loop: "{{ interfaces }}"
  loop_control:
    loop_var: interface
