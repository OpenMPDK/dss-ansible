---

- name: Assert tcp_ip_list and rocev2_ip_list are defined
  assert:
    that:
      - tcp_ip_list is defined
      - rocev2_ip_list is defined
    fail_msg: "Must have `tcp_ip_list` and `rocev2_ip_list` defined for each host"

- name: Install Soft-RoCE dependencies
  package:
      name: "{{ packages }}"
      state: present
  vars:
      packages:
      - rdma
      - libibverbs-utils
      - librdmacm-utils
  become: true

- name: Create Soft-RoCE service file
  blockinfile:
    path: /etc/systemd/system/softroce.service
    create: yes
    block: |
      [Unit]
      Description=Load Soft-RoCE
      After=network.target

      [Service]
      Type=simple
      ExecStart=/bin/rxe_cfg start

      [Install]
      WantedBy=multi-user.target
  become: true

- name: Start and Enable Soft-RoCE
  systemd:
    name: softroce.service
    state: started
    enabled: yes
  become: true

- name: Query Soft-RoCE Configuration
  shell: "rxe_cfg status | grep {{ rdma_interface }} | awk '{ print $7 }'"
  changed_when: false
  register: softroce_status
  become: true

- name: Test if configured
  debug:
    msg: "Interface {{ rdma_interface }} is configured"
  when: softroce_status.stdout is regex("^rxe[0-9]+")
  become: true

- name: Test if not configured
  debug:
    msg: "Interface {{ rdma_interface }} is not configured"
  when: not softroce_status.stdout is regex("^rxe[0-9]+")
  become: true

- name: Attach second interface to Soft-RoCE
  shell: "rxe_cfg add {{ rdma_interface }}"
  when: not softroce_status.stdout is regex("^rxe[0-9]+")
  become: true
