---

- name: Install DSS benchmark dependencies
  yum:
    name:
      - python3
      - zstd
  become: true

- name: Identify benchmark tarball
  find:
    path: "{{ deploy_dss_benchmark_path }}"
    patterns: 'dss-benchmark-*.gz'
  delegate_to: localhost
  run_once: true
  register: benchmark_tgz

- name: Create benchmark destination path
  file:
    path: "{{ deploy_dss_benchmark_dest_dir }}"
    state: directory
    mode: '0555'
  register: create_benchmark_dir
  become: true

- name: Deploy benchmark from tarball
  unarchive:
    src: "{{ (benchmark_tgz.files | sort(attribute='ctime', reverse=true) | first).path }}"
    dest: "{{ deploy_dss_benchmark_dest_dir }}"
    extra_opts: [--strip-components=1]
  when: create_benchmark_dir.changed  # noqa 503
  become: true

- name: Copy Master SSH keys to all clients and servers
  include_tasks: copy_keys.yml
