---

- name: Install DSS benchmark dependencies
  yum:
    name:
      - python3
      - zstd
  become: true

- name: Identify benchmark tarball
  find:
    path: "{{ deploy_dss_benchmark_path }}"
    patterns: 'dss-benchmark-*.gz'
  delegate_to: localhost
  run_once: true
  register: benchmark_tgz

- name: Identify target tarball
  find:
    path: "{{ deploy_dss_benchmark_path }}"
    patterns: 'nkv-target*.tgz'
  delegate_to: localhost
  run_once: true
  register: target_tgz

- name: Create benchmark destination path
  file:
    path: "{{ deploy_dss_benchmark_dest_dir }}"
    state: directory
    mode: 0555
  register: create_benchmark_dir
  become: true

- name: Deploy benchmark from tarball
  unarchive:
    src: "{{ (benchmark_tgz.files | sort(attribute='ctime', reverse=true) | first).path }}"
    dest: "{{ deploy_dss_benchmark_dest_dir }}"
    extra_opts: [--strip-components=2]
    owner: root
    group: root
  when: create_benchmark_dir.changed
  become: true

- name: Deploy ustat from target tarball
  unarchive:
    src: "{{ (target_tgz.files | sort(attribute='ctime', reverse=true) | first).path }}"
    dest: "{{ deploy_dss_benchmark_dest_dir }}"
    extra_opts:
      - --strip=2
      - --wildcards
      - '*/ustat'
    owner: root
    group: root
  when: create_benchmark_dir.changed
  become: true

- name: Install python dependencies from requirements.txt
  command: "python3 -m pip install -r {{ deploy_dss_benchmark_dest_dir }}/scripts/requirements.txt"
  register: benchmark_requirements
  changed_when: "'Successfully installed' in benchmark_requirements.stdout"
  become: true

- name: Copy Master SSH keys to all clients and servers
  include_tasks: copy_keys.yml

- name: Create log dir
  file:
    path: "{{ deploy_dss_benchmark_log_dir }}"
    state: directory
  become: true
