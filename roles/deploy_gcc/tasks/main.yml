---

- name: Identify GCC RPM
  find:
    path: "{{ deploy_gcc_path }}"
    patterns: 'kewb-gcc*.rpm'
  delegate_to: localhost
  run_once: true
  register: gcc_rpm

- name: Assert GCC RPM found
  assert:
    that: gcc_rpm.files | length > 0
    fail_msg: "No gcc RPM found. Please download RPM to {{ deploy_gcc_path }}"

- name: Identify newest version of GCC RPM found
  set_fact:
    gcc_rpm_file: "{{ (gcc_rpm.files | sort(attribute='ctime', reverse=true) | first).path }}"
  run_once: true

- name: Check if GCC RPM is installed
  shell: "rpm -qa | grep {{ gcc_rpm_file | basename | splitext | first }}"
  args:
    warn: false
  register: gcc_rpm_qa
  changed_when: false
  failed_when: false

- name: Copy GCC RPM to staging directory
  copy:
    src: "{{ gcc_rpm_file }}"
    dest: "{{ deploy_gcc_staging_dir }}"
    mode: 0644
  when: gcc_rpm_qa.rc != 0

- name: Install GCC RPM
  yum:
    name: "{{ deploy_gcc_staging_dir }}/{{ gcc_rpm_file | basename }}"
  become: yes
  when: gcc_rpm_qa.rc != 0

- name: Delete GCC RPM from staging directory
  file:
    path: "{{ deploy_gcc_staging_dir }}/{{ gcc_rpm_file | basename }}"
    state: absent
