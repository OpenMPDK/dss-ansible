---

- name: Append IP to vlan_ip_list for VLAN ID {{ vlan.id }}
  set_fact:
    vlan_ip_list: "{{ vlan_ip_list | default([]) + [ lookup('vars', vlan_device).ipv4.address ] }}"
  loop: "{{ mellanox_ports }}"
  loop_control:
    loop_var: mellanox_device
    label: "{{ mellanox_device.netdev }}.{{ vlan.id }}"
  vars:
    vlan_device: "ansible_{{ mellanox_device.netdev | replace('-', '_') }}.{{ vlan.id }}"
  when:
    - mellanox_device.status == 'Up'
    - lookup('vars', vlan_device, default='') != ''
    - lookup('vars', vlan_device).ipv4.address is defined
