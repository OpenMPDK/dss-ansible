---

- name: Get list of Mellanox ports
  include_role:
    name: get_mlnx_ports
  when: mellanox_devices is not defined

- name: Find existing vlan configuration for each adapter
  find:
    paths: /etc/sysconfig/network-scripts/
    use_regex: true
    patterns: "ifcfg-{{ item.netdev }}\\.[\\d]+"
  register: configured_vlan_files
  loop: "{{ mellanox_devices }}"
  loop_control:
    label: "{{ item.netdev }}"

- name: Define configured_vlans variable
  set_fact:
    configured_vlans: "{{ configured_vlans | default([]) }} + {{ item.files | map(attribute='path') | list }}"
  loop: "{{ configured_vlan_files.results  }}"
  loop_control:
    label: "{{ item.item.netdev }}"
  when: item.files | length > 0

- name: Remove existing configured VLANs
  file:
    path: "{{ item }}"
    state: absent
  loop: "{{ configured_vlans }}"
  notify:
    - Restart network service
    - Reload facts
  when: configured_vlans is defined
  become: true

- meta: flush_handlers
