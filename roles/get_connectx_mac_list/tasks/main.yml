---

- name: Get list of Mellanox ports
  include_role:
    name: get_mlnx_ports
  when: mellanox_devices is not defined

- name: Get list of MAC addresses
  set_fact:
    connectx_mac_address_list: "{{ connectx_mac_address_list | default([]) + [ mac_address ] }}"
  loop: "{{ mellanox_devices }}"
  loop_control:
    loop_var: mellanox_device
    label: "{{ mellanox_device.netdev }}"
  vars:
    vlan_device: "ansible_{{ mellanox_device.netdev }}"
    mac_address: "{{ lookup('vars', vlan_device).macaddress }}"
  when:
    - mellanox_device.status == 'Up'
    - lookup('vars', vlan_device, default='') != ''  # noqa 602

- name: Set combined_connectx_mac_list
  set_fact:
    combined_connectx_mac_list: "{{ combined_mac_list | default([]) }} + {{ hostvars[host].connectx_mac_address_list }}"
  loop: "{{ ansible_play_hosts }}"
  loop_control:
    loop_var: host
  run_once: true
