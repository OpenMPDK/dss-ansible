---

- name: Get list of devices for {{ vlan_label }}
  include_role:
    name: get_vlan_devices
  vars:
    vlan_list: "{{ pfc_vlan_list }}"

- name: Query mlnx_qos for {{ vlan_label }}
  command: "mlnx_qos -i {{ vlan_device }}"
  register: mlnx_qos
  changed_when: false
  loop: "{{ vlan_device_list }}"
  loop_control:
    loop_var: vlan_device

- name: Set mlnx_qos for {{ vlan_label }}
  command: "mlnx_qos -i {{ item.vlan_device }} -f {{ set_pfc_string }}"
  loop: "{{ mlnx_qos.results }}"
  loop_control:
    label: "{{ item.vlan_device }}"
  vars:
    get_pfc_string: "{% for p in range(8) %}{% if p in priority_list %}1{% else %}0{% endif %}{% if not loop.last %}   {% endif %}{% endfor %}"
    set_pfc_string: "{% for p in range(8) %}{% if p in priority_list %}1{% else %}0{% endif %}{% if not loop.last %},{% endif %}{% endfor %}"
    qos_regex: "enabled +{{ get_pfc_string }}"
  when: item.stdout is not regex(qos_regex)
