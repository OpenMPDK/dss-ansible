---

- name: Assert rocev2_vlans and tcp_vlans lists are balanced
  assert:
    that: rocev2_vlans | count == tcp_vlans | count
    fail_msg: "Found {{ rocev2_vlans | count }} rocev2_vlans and {{ tcp_vlans | count }} tcp_vlans. These numbers must match."
    success_msg: "Found {{ rocev2_vlans | count }} rocev2_vlans and {{ tcp_vlans | count }} tcp_vlans."

- name: Set combined_vlans list
  set_fact:
    combined_vlans: "{{ combined_vlans | default([]) + [ item.0 ] + [ item.1 ] }}"
  run_once: true
  with_together:
    - "{{ rocev2_vlans }}"
    - "{{ tcp_vlans }}"
  loop_control:
    label: "rocev2 id: {{ item.0.id }}, tcp id: {{ item.1.id }}"

- name: Get IP address last octet for ConnectX Devices
  include_tasks: get_last_octet.yml

- name: Get list of Mellanox devices
  include_role:
    name: get_mlnx_devices
  when: mellanox_devices is not defined

- name: Set up_devices list
  set_fact:
    up_devices: "{{ mellanox_devices | selectattr('status', 'equalto', 'Up') | list }}"

- name: Assert (number of up_devices * num_vlans_per_nic) == number of VLANs
  assert:
    that: (up_devices | count) * num_vlans_per_nic == combined_vlans | count
    fail_msg: |
      Found {{ up_devices | count }} 'Up' ConnectX adapters with {{ num_vlans_per_nic }} VLANs per NIC.
      The sum of which needs to match the number of VLAN's: {{ combined_vlans | count }}.
      Ensure all ConnectX adapters are connected to switch.
      If necessary, configure the list of 'rocev2_vlans' and 'tcp_vlans' in {{ playbook_dir }}/group_vars/all.yml
      Alternatively, adjust the 'num_vlans_per_nic' var in in {{ playbook_dir }}/group_vars/all.yml
    success_msg: >
      Found {{ up_devices | count }} 'Up' ConnectX adapters with {{ num_vlans_per_nic }}
      VLANS per NIC for {{ combined_vlans | count }} VLANs.

- name: Set vlan_up_devices var
  set_fact:
    vlan_up_devices: "{{ vlan_up_devices | default([]) + [ item.0 ] }}"
  with_nested:
    - "{{ up_devices }}"
    - "{{ range(num_vlans_per_nic) | list }}"
  loop_control:
    label: "{{ item.0.ibdev }} - {{ item.1 }}"

- name: Configure ConnectX adapters
  template:
    src: vlan_ifcfg.j2
    dest: "/etc/sysconfig/network-scripts/ifcfg-{{ device.netdev }}.{{ vlan.id }}"
  with_together:
    - "{{ vlan_up_devices }}"
    - "{{ combined_vlans }}"
  loop_control:
    label: "{{ device.ibdev }}: {{ vlan.id }}"
  vars:
    device: "{{ item.0 }}"
    vlan: "{{ item.1 }}"
    priority: "{{ (vlan.id | string)[0] }}"
  notify:
    - Restart network service
    - Reload facts
  become: true

- meta: flush_handlers

- name: Configure IRQ
  include_role:
    name: configure_connectx_irq

- name: Configure DCQCN for each device
  include_tasks: configure_dcqcn.yml
  vars:
    vlan_label: "{{ vlangroup.label }}"
    configure_vlan_list: "{{ vlangroup.vlan_list }}"
  loop:
    - label: RoCEv2 VLANs
      vlan_list: "{{ rocev2_vlans }}"
    - label: TCP VLANs
      vlan_list: "{{ tcp_vlans }}"
  loop_control:
    loop_var: vlangroup

- meta: flush_handlers

# - name: Configure PFC for each adapter
#   include_tasks: configure_pfc.yml
#   vars:
#     vlan_label: "{{ vlangroup.label }}"
#     pfc_vlan_list: "{{ vlangroup.vlan_list }}"
#     priority_list: "{{ vlangroup.priority_list }}"
#   loop:
#     - label: RoCEv2 VLANs
#       vlan_list: "{{ rocev2_vlans }}"
#       priority_list: "{{ rocev2_priority_list }}"
#     - label: TCP VLANs
#       vlan_list: "{{ tcp_vlans }}"
#       priority_list: "{{ tcp_priority_list }}"
#   loop_control:
#     loop_var: vlangroup
