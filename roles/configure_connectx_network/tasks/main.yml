---

- name: Assert rocev2_vlans and tcp_vlans lists are balanced
  assert:
    that: rocev2_vlans | count == tcp_vlans | count
    fail_msg: "Found {{ rocev2_vlans | count }} rocev2_vlans and {{ tcp_vlans | count }} tcp_vlans. These numbers must match."
    success_msg: "Found {{ rocev2_vlans | count }} rocev2_vlans and {{ tcp_vlans | count }} tcp_vlans."

- name: Set combined_vlans list
  set_fact:
    combined_vlans: "{{ combined_vlans | default([]) + [ item.0 ] + [ item.1 ] }}"
  run_once: true
  with_together:
    - "{{ rocev2_vlans }}"
    - "{{ tcp_vlans }}"
  loop_control:
    label: "rocev2 id: {{ item.0.id }}, tcp id: {{ item.1.id }}"

- name: Get IP address last octet for ConnectX Devices
  include_tasks: get_last_octet.yml

- name: Get list of Mellanox devices
  include_role:
    name: get_mlnx_devices
  when: mellanox_devices is not defined

- name: Set up_devices list
  set_fact:
    up_devices: "{{ mellanox_devices | selectattr('status', 'equalto', 'Up') | list }}"

- name: Assert number of 'Up' adapters == number of VLANs
  assert:
    that: up_devices | count == combined_vlans | count
    fail_msg: |
      Found {{ up_devices | count }} 'Up' ConnectX adapters.
      This needs to match the number of VLAN's: {{ combined_vlans | count }}.
      Ensure all ConnectX adapters are connected to switch.
      If necessary, configure the list of 'rocev2_vlans' and 'tcp_vlans' in {{ playbook_dir }}/group_vars/servers.yml
    success_msg: "Found {{ up_devices | count }} 'Up' ConnectX adapters for {{ combined_vlans | count }} VLANs."

- name: create test dir for template (TEMPORARY)
  file:
    path: /tmp/mlnx_vlan_test
    state: directory

- name: Configure ConnectX adapters
  template:
    src: vlan_ifcfg.j2
    dest: "/etc/sysconfig/network-scripts/ifcfg-{{ device.netdev }}.{{ vlan.id }}"
  with_together:
    - "{{ up_devices }}"
    - "{{ combined_vlans }}"
  loop_control:
    label: "{{ device.ibdev }}: {{ vlan.id }}"
  vars:
    device: "{{ item.0 }}"
    vlan: "{{ item.1 }}"
    priority: "{{ (vlan.id | string)[0] }}"
  notify:
    - Restart network service
    - Reload facts
  become: true
