---

- name: Get name of local Fabric Mananger RPM
  find:
    path: "{{ inventory_dir }}/artifacts/"
    patterns: 'ufm-*.rpm'
  delegate_to: localhost
  run_once: true
  register: ufm_rpm

- name: Get name of local Fabric Mananger Broker RPM
  find:
    path: "{{ inventory_dir }}/artifacts/"
    patterns: 'ufmbroker-*.rpm'
  delegate_to: localhost
  run_once: true
  register: ufmbroker_rpm

- name: Fail if packages are missing
  fail:
    msg: "Missing UFM packages. Check `{{ inventory_dir }}/artifacts` and execute build scripts if empty."
  delegate_to: localhost
  run_once: true
  when: >
    ufm_rpm.files[0].path is undefined or
    ufmbroker_rpm.files[0].path is undefined

- name: Install FabricManager - CentOS
  import_tasks: ufm_centos.yml
  when: ansible_os_family == 'RedHat'

- name: Start Services
  systemd:
    name: "{{ item }}"
    state: started
    enabled: yes
    daemon_reload: yes
  loop:
    - ufm
    - ufm_api
  become: yes

- name: Check that UFM services are running
  service:
    name: "{{ item }}"
  register: service_status
  failed_when: service_status.status.ActiveState != "active"
  loop:
    - ufm_etcd
    - ufm
    - ufm_msg_broker.service
    - ufm_api

- name: Delete RPM files from Fabric Mananger Hosts
  file:
    path: "{{ ufm_devtest_staging_dir }}/{{ item | basename }}"
    state: absent
  loop:
    - "{{ ufm_rpm.files[0].path }}"
    - "{{ ufmbroker_rpm.files[0].path }}"
  loop_control:
    label: "{{ ufm_devtest_staging_dir }}/{{ item | basename }}"
