#  BSD LICENSE
#
#  Copyright (c) 2021 Samsung Electronics Co., Ltd.
#  All rights reserved.
#
#  Redistribution and use in source and binary forms, with or without
#  modification, are permitted provided that the following conditions
#  are met:
#
#    * Redistributions of source code must retain the above copyright
#      notice, this list of conditions and the following disclaimer.
#    * Redistributions in binary form must reproduce the above copyright
#      notice, this list of conditions and the following disclaimer in
#      the documentation and/or other materials provided with the
#      distribution.
#    * Neither the name of Samsung Electronics Co., Ltd. nor the names of
#      its contributors may be used to endorse or promote products derived
#      from this software without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
#  "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
#  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
#  A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
#  OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
#  LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
#  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
#  THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
#  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
#  OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
---

- name: Get ip route
  command: ip route show
  environment:
    PATH: "{{ ansible_env.PATH }}:/sbin:/usr/sbin"
  changed_when: false
  register: ip_route

- name: Set rocev2_dev
  set_fact:
    rocev2_dev_list: "{{ rocev2_dev_list | default([]) +
                      [{ 'ip_prefix': vlan.ip_prefix,
                          'dev': device }] }}"
  loop: "{{ rocev2_vlans }}"
  loop_control:
    loop_var: vlan
    label: "{{ vlan.id }}"
  vars:
    dev_regex: >-
      {{ vlan.ip_prefix }}\.0\/\d+ dev ([^. ]+)
    device: "{{ ip_route.stdout | regex_search(dev_regex, '\\1') | first }}"
  when:
    - ip_route.stdout is regex(vlan.ip_prefix)

- name: Get NUMA
  command: "cat /sys/class/net/{{ item.dev }}/device/numa_node"
  changed_when: false
  loop: "{{ rocev2_dev_list }}"
  loop_control:
    label: "{{ item.dev }}"
  register: numa_node

- name: Set rocev2_numa_prefix_list
  set_fact:
    rocev2_numa_prefix_list: "{{ rocev2_numa_prefix_list | default([]) +
                          [{ 'ip_prefix': vlan.item.ip_prefix,
                              'numa': vlan.stdout | int }] }}"
  loop: "{{ numa_node.results }}"
  loop_control:
    loop_var: vlan
    label: "{{ vlan.item.dev }}"

- name: Execute nkv_test_cli put
  include_tasks: nkv_test_cli.yml
  vars:
    operation: "{{ test_nkv_test_cli_put }}"

- name: Set put_bandwidth
  set_fact:
    put_bandwidth: "{{ combined_bandwidth }}"

- name: Execute nkv_test_cli get
  include_tasks: nkv_test_cli.yml
  vars:
    operation: "{{ test_nkv_test_cli_get }}"

- name: Set get_bandwidth
  set_fact:
    get_bandwidth: "{{ combined_bandwidth }}"

- name: Execute nkv_test_cli delete
  include_tasks: nkv_test_cli.yml
  vars:
    operation: "{{ test_nkv_test_cli_delete }}"

- name: Print bandwidth
  debug:
    msg: |
      Put bandwidth:    {{ '%0.2f' | format(put_bandwidth | float) }} GB/s
      Get bandwidth:    {{ '%0.2f' | format(get_bandwidth | float) }} GB/s
  run_once: true
