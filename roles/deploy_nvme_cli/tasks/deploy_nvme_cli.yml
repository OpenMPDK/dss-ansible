---

- name: Install nvme-cli build dependencies
  yum:
    name: gcc
  become: true

- name: Uninstall package manager version of nvme-cli
  yum:
    name: nvme-cli
    state: absent
  become: true

- name: Uninstall existing version of nvme-cli
  import_tasks: remove_nvme_cli.yml

- name: Create nvme-cli staging directory
  file:
    path: "{{ deploy_nvme_cli_staging_dir }}"
    state: directory

- name: Download nvme-cli source
  unarchive:
    src: "{{ deploy_nvme_cli_url }}"
    dest: "{{ deploy_nvme_cli_staging_dir }}"
    remote_src: true
    extra_opts: [--strip-components=1]

- name: Make nvme-cli
  command: make
  args:
    chdir: "{{ deploy_nvme_cli_staging_dir }}"   # noqa 301

- name: Copy nvme-cli to sbin path
  copy:
    src: "{{ deploy_nvme_cli_staging_dir }}/nvme"
    dest: /usr/local/bin/nvme
    mode: 0751
    force: true
    remote_src: true
  become: true

- name: Delete nvme-cli staging directory
  file:
    path: "{{ deploy_nvme_cli_staging_dir }}"
    state: absent
