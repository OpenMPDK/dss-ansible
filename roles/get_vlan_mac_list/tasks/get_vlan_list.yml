---

- name: Get list of MAC addresses for VLAN ID {{ vlan.id }}
  include_tasks: get_mac_list.yml

- name: Initialize combined_mac_list
  set_fact:
    combined_mac_list: []

- name: Set combined_mac_list
  set_fact:
    combined_mac_list: "{{ combined_mac_list | default([]) }} + {{ hostvars[host].mac_address_list }}"
  loop: "{{ ansible_play_hosts }}"
  loop_control:
    loop_var: host
  run_once: true

- name: Set vlan_mac_list for VLAN ID {{ vlan.id }}
  set_fact:
    vlan_mac_list: "{{ vlan_mac_list | default([]) +
      [{'id': vlan.id | int,
        'prefix': vlan_prefix,
        'mac_list': combined_mac_list }] }}"
  run_once: true
