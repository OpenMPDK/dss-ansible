---

- name: Get list of Mellanox adapters
  include_role:
    name: get_mlnx_devices

- name: Set mlx_ip_list
  set_fact:
    mlx_ip_list: []

- name: Get IP of active interfaces
  include_tasks: get_mlx_ip.yml
  loop: "{{ mellanox_devices }}"
  vars:
    mellanox_device: "{{ item }}"
  loop_control:
    label: "{{ item.ibdev }}"

- name: Assert that at least one Mellanox IP is present
  assert:
    that: mlx_ip_list | length > 0
    fail_msg: "No IPs configured on any Mellanox adapter. Please configure at least one IP to deploy target."
    success_msg: "Mellanox IP(s) detected."

- name: Debug dss_target.py output
  debug:
    msg: >
      ./dss_target.py configure --ip_addrs
      {% for ip in mlx_ip_list %}{{ ip }}{% if not loop.last %} {% endif %}{% endfor %}
      -kv_fw <<placeholder>>
      -kv_ssc <<placeholder>>
