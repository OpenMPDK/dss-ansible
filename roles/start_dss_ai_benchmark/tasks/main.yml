#  BSD LICENSE
#
#  Copyright (c) 2021 Samsung Electronics Co., Ltd.
#  All rights reserved.
#
#  Redistribution and use in source and binary forms, with or without
#  modification, are permitted provided that the following conditions
#  are met:
#
#    * Redistributions of source code must retain the above copyright
#      notice, this list of conditions and the following disclaimer.
#    * Redistributions in binary form must reproduce the above copyright
#      notice, this list of conditions and the following disclaimer in
#      the documentation and/or other materials provided with the
#      distribution.
#    * Neither the name of Samsung Electronics Co., Ltd. nor the names of
#      its contributors may be used to endorse or promote products derived
#      from this software without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
#  "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
#  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
#  A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
#  OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
#  LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
#  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
#  THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
#  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
#  OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
---

- name: Get MinIO Hostnames
  include_role:
    name: get_minio_hostnames

- name: Set combined_endpoints var
  set_fact:
    combined_endpoints: "{{ combined_endpoints | d([]) }} +
    {% for tcp in hostvars[server].tcp_alias_list %}
      [
        {{ tcp }}{% if not loop.last %},{% endif %}
      ]{% if not loop.last %} +{% endif %}
    {% endfor %}
    "
  loop: "{{ minio_hostnames }}"
  loop_control:
    loop_var: server
  run_once: true

- name: Check minio connection
  command: "{{ minio_dir }}/mc ls {{ minio_mc_alias }}"
  when: inventory_hostname in groups['clients']
  changed_when: false

- name: Get minio url from mc
  command: "{{ minio_dir }}/mc config host list {{ minio_mc_alias }} --json"
  when: inventory_hostname in groups['clients']
  register: mc_host_config
  changed_when: false

- name: Set minio_server and minio_host vars
  set_fact:
    minio_server: "{{ mc_url | regex_search(mc_re, '\\1') | first }}"
    minio_host: "{{ mc_url | regex_search(mc_re, '\\2') | first }}"
  vars:
    mc_re: '^http://(([^:]+):.+)'
    mc_url: "{{ (mc_host_config.stdout | from_json).URL | default('') }}"
  when: inventory_hostname in groups['clients']

- name: Assert IPV4
  assert:
    that: endpoint_family == 'IPV4'
    msg: "DSS AI Benchmark does not currently support IPV6"
  vars:
    endpoint_family: "{{ (combined_endpoints | selectattr('alias', 'equalto', minio_host) | first).family }}"
  when: inventory_hostname in groups['clients']

- name: Set benchmark_bucket var
  set_fact:
    benchmark_bucket: >-
      {%- for client_host in groups['clients'] -%}
      {%- if inventory_hostname == client_host -%}
      {{ benchmark_bucket_prefix }}{{ loop.index0 }}
      {%- endif -%}
      {%- endfor -%}
  when: inventory_hostname in groups['clients']

- name: Set subnets var
  set_fact:
    subnets: "{{ subnets | d([]) }} +
      [
        {
          'minioServers': ['{{ hostvars[client_host].minio_server }}'],
          'minioHosts': ['{{ hostvars[client_host].minio_host }}'],
          'minioBucket': '{{ hostvars[client_host].benchmark_bucket }}',
          'warpClients': ['{{ hostvars[client_host].tcp_alias_list[0].alias }}']
        }
      ]"
  loop: "{{ groups['clients'] }}"
  loop_control:
    loop_var: client_host
  when: inventory_hostname in groups['clients']
  run_once: true

- name: Generate cluster.json template to master client
  template:
    src: cluster.json.j2
    dest: "{{ ai_benchmark_dir }}/cluster.json"
    mode: 0644
  run_once: true
  when: inventory_hostname in groups['clients']
  register: cluster_json
  become: true

- name: Copy image.json to master client
  copy:
    src: image.json
    dest: "{{ ai_benchmark_dir }}/image.json"
    mode: 0644
  run_once: true
  when: inventory_hostname in groups['clients']
  register: image_json
  become: true


- name: Create dss_benchmark_generate.sh script
  copy:
    content: >
      python3
      {{ ai_benchmark_dir }}/scripts/bench.py
      generate
      --cluster-config {{ ai_benchmark_dir }}/cluster.json
      --obj-dist-file {{ ai_benchmark_dir }}/image.json
      --objects {{ benchmark_objects }}
      --warp-binary {{ ai_benchmark_dir }}/warp
      --access-key {{ minio_access_key }}
      --secret-key "{{ minio_secret_key }}"
      --output-dir {{ dss_log_dir }}
      --client-start-port {{ benchmark_client_start_port }}
    dest: "{{ ai_benchmark_dir }}/scripts/dss_benchmark_generate.sh"
    mode: 0755
  run_once: true
  when: inventory_hostname in groups['clients']
  become: true

- name: Create dss_benchmark.sh script
  copy:
    content: >
      python3
      {{ ai_benchmark_dir }}/scripts/bench.py
      benchmark
      --num-clients {{ benchmark_clients }}
      --rate-limit {{ benchmark_rate_limit }}
      --software-rate-limit {{ benchmark_software_rate_limit }}
      --ustat-profiles "{{ benchmark_ustat_profiles }}"
      --warp-binary {{ ai_benchmark_dir }}/warp
      --access-key {{ minio_access_key }}
      --secret-key "{{ minio_secret_key }}"
      --output-dir {{ dss_log_dir }}
      --duration {{ benchmark_duration }}
      --concurrent {{ benchmark_concurrent }}
      --cap {{ benchmark_cap }}
      --cluster-config {{ ai_benchmark_dir }}/cluster.json
      --ustat-binary-path {{ ai_benchmark_dir }}/ustat
      --client-start-port {{ benchmark_client_start_port }}
    dest: "{{ ai_benchmark_dir }}/scripts/dss_benchmark.sh"
    mode: 0755
  run_once: true
  when: inventory_hostname in groups['clients']
  become: true

- name: Check if benchmark data needs to be re-generated
  command: |
    {{ ai_benchmark_dir }}/scripts/check_bucket.py
    --server {{ minio_host }}:{{ minio_port }}
    --access-key {{ minio_access_key }}
    --secret-key {{ minio_secret_key }}
    --bucket {{ benchmark_bucket }}
    --objs {{ benchmark_objects }}
  changed_when: false
  failed_when: false
  register: check_bucket_results
  when: inventory_hostname in groups['clients']


- name: Prepare and execute benchmark
  block:
    - name: Execute generate on master client
      shell: >
        set -o pipefail &&
        {{ ai_benchmark_dir }}/scripts/dss_benchmark_generate.sh
        | tee -a {{ dss_log_dir }}/nkv-benchmark-generate.log
      run_once: true
      register: bench_generate
      no_log: true
      vars:
        check_bucket_rc_list: |
          [
            {% for client_host in groups['clients'] %}
              {{ hostvars[client_host].check_bucket_results.rc }}{% if not loop.last %},{% endif %}
            {% endfor %}
          ]
      when:
        - inventory_hostname in groups['clients']
        - check_bucket_rc_list | sort | last != 0 or
          cluster_json.changed or
          image_json.changed
      become: true

    - name: Start Compaction
      include_role:
        name: start_compaction
      when:
        - inventory_hostname in groups['servers'] | d([]) or inventory_hostname in groups['targets'] | d([])
        - dss_target_mode is search('kv_block')
        - bench_generate.changed

    - name: Get all RoCEv2 IP Addresses
      include_role:
        name: get_vlan_ips
      vars:
        vlan_list: "{{ rocev2_vlans }}"
      when:
        - rocev2_ip_list is not defined
        - inventory_hostname in groups['servers'] | d([]) or inventory_hostname in groups['hosts'] | d([])

    - name: Set rocev2_ip_list var if IP's auto-discovered
      set_fact:
        rocev2_ip_list: "{{ vlan_ip_list }}"
      when: rocev2_ip_list is not defined

    - name: Enable ustat
      lineinfile:
        path: "{{ nkv_sdk_conf_dir }}/nkv_config_{{ rocev2_ip }}.json"
        regexp: '^( +"nkv_need_path_stat":)'
        line: '\1 1,'
        backrefs: true
      when: inventory_hostname in groups['servers'] | d([]) or inventory_hostname in groups['hosts'] | d([])
      loop: "{{ rocev2_ip_list }}"
      loop_control:
        loop_var: rocev2_ip
      become: true

    - name: Execute benchmark on master client
      shell: >
        set -o pipefail &&
        {{ ai_benchmark_dir }}/scripts/dss_benchmark.sh
        | tee -a {{ dss_log_dir }}/nkv-benchmark.log
      run_once: true
      register: bench_benchmark
      no_log: true
      when: inventory_hostname in groups['clients']
      become: true

  rescue:
    - name: Terminate failed benchmark
      command: >
        python3
        {{ ai_benchmark_dir }}/scripts/bench.py
        terminate
        --cluster-config {{ ai_benchmark_dir }}/cluster.json
      run_once: true
      when: inventory_hostname in groups['clients']
      become: true

    - name: Remove packet pacing from servers
      include_role:
        name: remove_packet_pacing
      when: inventory_hostname in groups['servers'] | d([]) or inventory_hostname in groups['hosts'] | d([])

    - name: Benchmark Generate Failed
      fail:
        msg: |
          -- bench.py generate command --
          {{ bench_generate.cmd }}
          -- generate log --
          {{ bench_generate.stderr }}
      when:
        - bench_generate.failed is defined
        - bench_generate.failed
        - inventory_hostname in groups['clients']
      run_once: true

    - name: Benchmark Failed
      fail:
        msg: |
          -- bench.py benchmark command --
          {{ bench_benchmark.cmd }}
          -- benchmark log --
          {{ bench_benchmark.stderr }}
      when:
        - bench_benchmark.failed is defined
        - bench_benchmark.failed
        - inventory_hostname in groups['clients']
      run_once: true

  always:
    - name: Disable ustat
      lineinfile:
        path: "{{ nkv_sdk_conf_dir }}/nkv_config_{{ rocev2_ip }}.json"
        regexp: '^( +"nkv_need_path_stat":)'
        line: '\1 0,'
        backrefs: true
      when: inventory_hostname in groups['servers'] | d([]) or inventory_hostname in groups['hosts'] | d([])
      loop: "{{ rocev2_ip_list }}"
      loop_control:
        loop_var: rocev2_ip
      become: true
