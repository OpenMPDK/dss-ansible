---

- name: Create staging directory for Kernel RPMs
  file:
    path: "{{ deploy_kernel_staging_dir }}"
    state: directory
    mode: 0644

- name: Copy Kernel RPMs
  copy:
    src: "{{ item.path }}"
    dest: "{{ deploy_kernel_staging_dir }}"
    mode: 0644
  loop: "{{ kernel_rpms.files }}"
  loop_control:
    label: "{{ item.path | basename }}"

- name: Install Kernel RPMs
  yum:
    name: "{{ deploy_kernel_staging_dir }}/{{ item.path | basename }}"
  become: true
  loop: "{{ kernel_rpms.files }}"
  loop_control:
    label: "{{ item.path | basename }}"

- name: Set default grub
  command: "grub2-set-default 'CentOS Linux ({{ target_kernel_version }}) 7 (Core)'"
  notify:
    - Reboot system - kernel
    - Gather facts post-reboot
  become: true

- name: Delete staging directory for Kernel RPMs
  file:
    path: "{{ deploy_kernel_staging_dir }}"
    state: absent
