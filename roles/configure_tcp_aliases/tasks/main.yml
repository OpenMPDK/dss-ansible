#  BSD LICENSE
#
#  Copyright (c) 2021 Samsung Electronics Co., Ltd.
#  All rights reserved.
#
#  Redistribution and use in source and binary forms, with or without
#  modification, are permitted provided that the following conditions
#  are met:
#
#    * Redistributions of source code must retain the above copyright
#      notice, this list of conditions and the following disclaimer.
#    * Redistributions in binary form must reproduce the above copyright
#      notice, this list of conditions and the following disclaimer in
#      the documentation and/or other materials provided with the
#      distribution.
#    * Neither the name of Samsung Electronics Co., Ltd. nor the names of
#      its contributors may be used to endorse or promote products derived
#      from this software without specific prior written permission.
#
#  THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
#  "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
#  LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
#  A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
#  OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
#  SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
#  LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
#  DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
#  THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
#  (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
#  OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
---

- name: Initialize vars
  set_fact:
    tcp_adapter_list: []
    tcp_adapter_parent_list: []
    tcp_adapter_numa_list: []
    tcp_alias_list: []
  
- name: Assert tcp_ip_list contains IP addresses
  assert:
    that: "{{ item | ipaddr != false }}"
    msg: "{{ item }} is not a valid IP address"
    quiet: true
  loop: "{{ tcp_ip_list }}"

- name: Set tcp_adapter_list var
  set_fact:
    tcp_adapter_list: "{{ tcp_adapter_list | d([]) }} +
      [
      {% for interface in ansible_interfaces %}
        {% set ipv6_address_list = (hostvars[inventory_hostname]['ansible_' + interface] | d({})).ipv6 | d([]) | map(attribute='address') | flatten %}
        {% set ipv4_address = ((hostvars[inventory_hostname]['ansible_' + interface] | d({})).ipv4 | d({})).address | default('') %}
        {% if (tcp_ip in ipv6_address_list) or (tcp_ip == ipv4_address) %}
          {
            'tcp_ip': '{{ tcp_ip }}',
            'interface': '{{ interface }}'
          }
        {% endif %}
      {% endfor %}
      ]"
  loop: "{{ tcp_ip_list }}"
  loop_control:
    loop_var: tcp_ip

- name: Assert IP addresses found on host 
  assert:
    that: item in tcp_adapter_list | map(attribute='tcp_ip') | list
    msg: "{{ item }} is not assigned to any adapter. Check 'tcp_ip_list' setting."
    quiet: true
  loop: "{{ tcp_ip_list }}"

- name: Get parent adapters
  shell: "echo $(basename $(readlink /sys/class/net/{{ item.interface }}/lower_* || echo '{{ item.interface }}'))"
  loop: "{{ tcp_adapter_list }}"
  loop_control:
    label: "{{ item.interface }}"
  changed_when: false
  register: parent_adapters

- name: Set tcp_adapter_parent_list var
  set_fact:
    tcp_adapter_parent_list: "{{ tcp_adapter_parent_list | default([]) }} +
      [
        {
          'parent_interface': '{{ item.stdout }}',
          'tcp_ip': '{{ item.item.tcp_ip }}',
          'interface': '{{ item.item.interface }}'
        }
      ]"
  loop: "{{ parent_adapters.results }}"
  loop_control:
    label: "{{ item.item.tcp_ip }}"

- name: Get NUMA for each adapter
  command: "cat /sys/class/net/{{ item.parent_interface }}/device/numa_node"
  changed_when: false
  loop: "{{ tcp_adapter_parent_list }}"
  loop_control:
    label: "{{ item.interface }}"
  register: numa_node

- name: Set tcp_adapter_numa_list var
  set_fact:
    tcp_adapter_numa_list: "{{ tcp_adapter_numa_list | default([]) }} +
      [
        {
          'parent_interface': '{{ item.item.parent_interface }}',
          'tcp_ip': '{{ item.item.tcp_ip }}',
          'interface': '{{ item.item.interface }}',
          'numa': {% if item.stdout == '-1' %}0{% else %}{{ item.stdout }}{% endif %}
        }
      ]"
  loop: "{{ numa_node.results }}"
  loop_control:
    label: "{{ item.item.tcp_ip }}"

- name: Sort tcp_adapter_numa_list by numa
  set_fact:
    tcp_adapter_numa_list: "{{ tcp_adapter_numa_list | sort(attribute='numa') }}"

- name: set tcp_alias_list var
  set_fact:
    tcp_alias_list: "{{ tcp_alias_list | default([]) }} +
      [
        {
          'parent_interface': '{{ item.parent_interface }}',
          'tcp_ip': '{{ item.tcp_ip }}',
          'interface': '{{ item.interface }}',
          'numa': {{ item.numa }},
          'alias': '{{ inventory_hostname_short}}-tcp-{{ ansible_loop.index0 }}'
        }
      ]"
  loop: "{{ tcp_adapter_numa_list }}"
  loop_control:
    label: "{{ item.tcp_ip }}"
    extended: true

- name: Set SERVER aliases in /etc/hosts
  blockinfile:
    path: /etc/hosts
    marker: "# {mark} ANSIBLE MANAGED BLOCK - SERVER TCP ALIASES FOR TESS"
    block: |
      {% for host in ansible_play_hosts %}
      {% if host in groups['servers'] %}
      {% for tcp_ip in hostvars[host].tcp_alias_list %}
      {{ tcp_ip.tcp_ip }} {{ tcp_ip.alias }}
      {% endfor %}
      {% endif %}
      {% endfor %}
  become: true

- name: Set CLIENT aliases in /etc/hosts
  blockinfile:
    path: /etc/hosts
    marker: "# {mark} ANSIBLE MANAGED BLOCK - CLIENT TCP ALIASES FOR TESS"
    block: |
      {% for host in ansible_play_hosts %}
      {% if host in groups['clients'] %}
      {% for tcp_ip in hostvars[host].tcp_alias_list %}
      {{ tcp_ip.tcp_ip }} {{ tcp_ip.alias }}
      {% endfor %}
      {% endif %}
      {% endfor %}
  when: inventory_hostname in groups['clients']
  become: true
