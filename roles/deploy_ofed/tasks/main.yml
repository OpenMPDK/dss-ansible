---

- name: Set OFED version variables
  set_fact:
    ofed_local_path: "{{ item.local_path }}"
    ofed_target_version: "{{ item.version }}"
    ofed_dir: "{{ item.dir }}"
  loop: "{{ ofed_files }}"
  loop_control:
    label: "{{ item.filename }}"
  when: ansible_distribution_version is version(item.distribution_version, '==')

- name: Check OFED version
  command: ofed_info -n
  failed_when: false
  changed_when: false
  register: ofed_version

- name: Deploy OFED
  import_tasks: deploy_ofed.yml
  when: >
    ofed_version.rc != 0 or
    ofed_version.stdout is version(ofed_target_version, '!=')

- name: Check OFED version post-deploy
  command: ofed_info -n
  changed_when: false
  register: post_ofed_version

- name: Assert target OFED version
  assert:
    that: post_ofed_version.stdout is version(ofed_target_version, '==')
    fail_msg: "Expected OFED version {{ ofed_target_version }} but found {{ post_ofed_version.stdout }}"
    success_msg: "Detected target OFED version {{ ofed_target_version }}"
